<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget</title>
    <link rel="stylesheet" href="budget.css">
</head>
<body>
    <div class="Wrapper">
        <form id="budgetForm">
            <h1>What's your budget</h1>
            <div>
                <label>My budget is:</label>
                <input type="number" placeholder="Enter budget amount" name="budget" id="budgetInput">
            </div>
            
            <h2>Enter your expenses:</h2>
            <table id="expenseTable">
                <tr>
                    <th>Payment</th>
                    <th>Category</th>
                    <th>Date</th>
                    <th>Action</th>
                </tr>
                <tr>
                    <td><input type="number" placeholder="Enter amount" name="payment[]"></td>
                    <td><input type="text" placeholder="Enter category" name="category[]"></td>
                    <td><input type="date" name="date[]"></td>
                    <td><button type="button" class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
                </tr>
            </table>
            
            <button type="button" class="add-btn" onclick="addRow()">Add Expense</button>
            <br><br>

            <div>
                <input type="reset" value="Reset">
            </div>
            <br>
            <div>
                <input type="submit" value="Submit">
            </div>
        </form>
    </div>

    <script>
        // Function to delete a row from the expense table
        function deleteRow(button) {
            var row = button.parentNode.parentNode;
            row.parentNode.removeChild(row);
            saveFormData();  // Save the updated data after row deletion
        }

        // Function to add a new row to the expense table
        function addRow() {
            var table = document.getElementById("expenseTable");
            var newRow = table.insertRow();
            var cell1 = newRow.insertCell(0);
            var cell2 = newRow.insertCell(1);
            var cell3 = newRow.insertCell(2);
            var cell4 = newRow.insertCell(3);

            cell1.innerHTML = '<input type="number" placeholder="Enter amount" name="payment[]">';
            cell2.innerHTML = '<input type="text" placeholder="Enter category" name="category[]">';
            cell3.innerHTML = '<input type="date" name="date[]">';
            cell4.innerHTML = '<button type="button" class="delete-btn" onclick="deleteRow(this)">Delete</button>';
            saveFormData();  // Save the updated data after adding a row
        }

        // Function to save form data to localStorage
        function saveFormData() {
            var budget = document.getElementById('budgetInput').value;
            var payments = [];
            var categories = [];
            var dates = [];
            var rows = document.getElementById("expenseTable").getElementsByTagName('tr');

            for (var i = 1; i < rows.length; i++) {
                var payment = rows[i].cells[0].getElementsByTagName('input')[0].value;
                var category = rows[i].cells[1].getElementsByTagName('input')[0].value;
                var date = rows[i].cells[2].getElementsByTagName('input')[0].value;

                if (payment && category && date) {
                    payments.push(payment);
                    categories.push(category);
                    dates.push(date);
                }
            }

            // Save the form data to localStorage
            localStorage.setItem('budgetData', JSON.stringify({
                budget: budget,
                payments: payments,
                categories: categories,
                dates: dates
            }));
        }

        // Function to load saved form data from localStorage
        function loadFormData() {
            var savedData = JSON.parse(localStorage.getItem('budgetData'));
            if (savedData) {
                document.getElementById('budgetInput').value = savedData.budget;
                var table = document.getElementById("expenseTable");

                // Clear existing rows
                var rows = table.getElementsByTagName('tr');
                while (rows.length > 1) {
                    table.deleteRow(1);
                }

                // Populate the table with saved data
                for (var i = 0; i < savedData.payments.length; i++) {
                    addRow();
                    table.rows[i + 1].cells[0].getElementsByTagName('input')[0].value = savedData.payments[i];
                    table.rows[i + 1].cells[1].getElementsByTagName('input')[0].value = savedData.categories[i];
                    table.rows[i + 1].cells[2].getElementsByTagName('input')[0].value = savedData.dates[i];
                }
            }
        }

        // Load the saved data when the page is loaded
        window.onload = function() {
            loadFormData();
        };

        // Handle form submission and send data to summary.html via query parameters
        document.getElementById('budgetForm').addEventListener('submit', function(e) {
            e.preventDefault();

            // Get the budget input
            var budget = document.getElementById('budgetInput').value;

            // Get all expenses
            var payments = [];
            var categories = [];
            var dates = [];
            var rows = document.getElementById("expenseTable").getElementsByTagName('tr');

            for (var i = 1; i < rows.length; i++) {
                var payment = rows[i].cells[0].getElementsByTagName('input')[0].value;
                var category = rows[i].cells[1].getElementsByTagName('input')[0].value;
                var date = rows[i].cells[2].getElementsByTagName('input')[0].value;

                if (payment && category && date) {
                    payments.push(payment);
                    categories.push(category);
                    dates.push(date); // Collect the dates
                }
            }

            // Determine the earliest and latest dates
            var earliestDate = dates.length ? new Date(Math.min(...dates.map(d => new Date(d)))) : null;
            var latestDate = dates.length ? new Date(Math.max(...dates.map(d => new Date(d)))) : null;

            // Format the dates as strings
            var formattedEarliestDate = earliestDate ? earliestDate.toISOString().split('T')[0] : 'N/A';
            var formattedLatestDate = latestDate ? latestDate.toISOString().split('T')[0] : 'N/A';

            // Create the query string
            var queryString = `budget=${budget}&payments=${payments.join(',')}&categories=${categories.join(',')}&startDate=${formattedEarliestDate}&endDate=${formattedLatestDate}`;

            // Redirect to summary.html with query parameters
            window.location.href = 'summary.html?' + queryString;

            // Save the form data before redirecting
            saveFormData();
        });
    </script>
</body>
</html>
